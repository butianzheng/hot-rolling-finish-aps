name: CI

on:
  # 主分支提交触发
  push:
    branches:
      - main
      - master
  # PR 触发
  pull_request:

permissions:
  contents: read

jobs:
  ci:
    # Tauri Linux 构建依赖与 apt 包在 Ubuntu 上最稳定
    runs-on: ubuntu-22.04

    steps:
      # 1) 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2) 安装 Node，并启用 npm 缓存（基于 package-lock.json）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3) 按仓库 rust-toolchain.toml 安装 Rust（含 rustfmt/clippy）
      - name: Setup Rust from rust-toolchain.toml
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
          rustflags: ""

      # 4) 安装 Linux 下构建 Tauri 所需系统依赖
      - name: Install Tauri system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      # 5) rustfmt 检查（与本地 cargo fmt --all 对齐）
      - name: Check Rust formatting
        run: cargo fmt --all -- --check

      # 6) Rust 测试
      - name: Run cargo test
        run: cargo test --workspace --all-targets --locked

      # 7) 前端依赖安装（严格按 lockfile）
      - name: Install frontend dependencies
        run: npm ci

      # 8) Tauri 构建（会先走前端构建，再打包桌面端）
      - name: Build Tauri app
        run: npm run tauri build
