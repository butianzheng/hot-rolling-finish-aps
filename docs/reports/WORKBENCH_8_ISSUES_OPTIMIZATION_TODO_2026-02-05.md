# Workbench 8 个问题：分析 / 方案 / TODO（持续更新）

最后更新：2026-02-05  
适用范围：开发库 30,000+ / 生产预期 50,000+ 材料规模（SQLite + Tauri）

---

## 背景与现状

- 近期现象：应用可启动，但出现 `no such column: user_confirmed` 等数据库查询失败；策略草案对比/发布及刷新状态出现 `Timeout`；数据量增大后卡顿明显。
- 关键约束：冻结区不可变更、适温约束不可绕过（除强制放行）、产能硬约束优先、生产库升级需可控（不做隐式自动迁移）。

---

## 8 个问题清单（按用户反馈逐条对齐）

> 状态说明：✅ 已完成 / 🟡 进行中 / ⬜ 待办

### 1) 单日排产量超出极限产能（明显业务错误）

- 状态：✅ 已完成
- 根因：冻结区物料未计入 `capacity_pool.used_capacity_t`，导致“计算区”在冻结项之上继续填充，出现“单日超限”。
- 修复要点：
  - 冻结区吨位计入 `used_capacity_t`，并同步记录到 `frozen_capacity_t`。
  - 新排产 `seq_no` 从当日冻结最大 `seq_no + 1` 开始，避免重复/覆盖。
- 验收（DoD）：
  - 当存在冻结项时，当日 `used_capacity_t` 必须包含冻结吨位。
  - 当日新增物料不会让“冻结吨位 + 新增吨位”突破极限后仍继续添加（非锁定/非强制放行情况）。

### 2) 适温/就绪状态随排产日期动态变化（冷料会变就绪）

- 状态：✅ 已完成
- 根因：Eligibility 判断使用了“静态的 output_age_days_raw”，在多日循环中未随 `current_date` 推进；导致 `PENDING_MATURE` 物料可能永久不可排。
- 修复要点：
  - 在日循环内按 `(current_date - start_date)` 推进 `output_age_days_raw` 再做 Eligibility 评估。
  - 成熟/未成熟统计口径改为以 Eligibility 输出为准（避免漂移）。
- 验收（DoD）：
  - 例：`output_age_days_raw=0` 且配置“冬季室温=3天”，则 `base_date+3` 后应可进入候选并可被排入产能池。

### 3) 产能池管理需要更便捷的批量调整

- 状态：✅ 已完成（第一阶段）
- 已实现：
  - 新增“一键批量调整（当前查询结果）”入口：无需逐条勾选即可批量更新目标/极限。
- 建议下一步（可选增强）：
  - ⬜ 增加“按机组×日期范围生成更新集”的批量操作（无需先加载表格）。
  - ⬜ 增加“常用模板/一键回填默认值”（例如目标/极限固定值随节奏微调）。

### 4) 重算窗口天数如何影响结果？是否应做成可选参数

- 状态：✅ 已完成
- 现状说明：
  - `recalc_window_days` 决定从 `base_date` 起参与重算的日期跨度（`end_date = base_date + window_days`）。
  - 窗口越大：候选物料可能被分摊到更远日期（更容易消化大批量），但计算与写入开销更大。
  - 窗口越小：更“聚焦近期”，但可能造成更多“挤出/未排”或短期超限压力集中。
- 已实现：
  - IPC：`simulate_recalc` / `recalc_full` 支持可选 `window_days_override`（范围 1-60；为空则跟随版本 `recalc_window_days`）。
  - One-Click Optimize：预览弹窗增加“窗口天数”输入框，可一键切换为“跟随版本”。
- 验收（DoD）：
  - 选择不同窗口天数时，重算结果在日期分布上应有可解释差异（吨位/件数分摊到更远日期）。
  - UI 能明确展示当前使用的窗口天数，并可一键切换。

### 5) 策略配置画面：展示预设策略参数（只读）供自定义参考

- 状态：✅ 已完成
- 已实现：
  - 后端 `get_strategy_presets` 补齐 `default_parameters`（排序口径 + 建议参数模板 + 说明）。
  - 前端策略配置页：
    - 预设策略卡片下方用折叠面板展示 `default_parameters`（只读）。
    - 自定义策略编辑弹窗展示“基于预设策略”的参数（只读），并提供“填入模板”便于复制到自定义参数。
- 验收（DoD）：
  - 用户创建/编辑自定义策略时可直观看到基于的预设策略参数/口径，且不可直接修改预设。

### 6) 所有画面重量数字统一保留两位小数

- 状态：✅ 已完成
- 已实现：
  - 统一 `formatWeight/formatCapacity` 为两位小数。
  - 修正多个表格/tooltip/摘要的吨位显示为两位小数，避免展示口径不一致。
- 验收（DoD）：
  - 所有显示单位为 `t/吨` 的重量/产能数字均为 `xx.xx` 格式（四舍五入）。

### 7) 物料管理 / 排程矩阵下物料清单需显示厚度、宽度等完整信息

- 状态：✅ 已完成
- 已实现：
  - 后端 `MaterialWithState` 与 `PlanItem` 增加 `width_mm/thickness_mm` 字段，并在 API 查询结果中补齐。
  - 前端 Material Management 与排程明细/矩阵明细表格新增宽度/厚度列。
- 验收（DoD）：
  - 在“材料管理”与“同日明细/排程清单”中均可直接看到厚度/宽度，不需再打开详情弹窗。

### 8) 文案：所有“冷坨消化”改为“冷料消化”

- 状态：✅ 已完成
- 已实现：
  - 前后端统一替换策略名称与相关下拉/配置文案为“冷料消化”。
- 验收（DoD）：
  - UI 中不再出现“冷坨消化”字样。

---

## 补充：数据库与 Timeout 问题（P0 稳定性）

### A) `no such column: user_confirmed`

- 根因：运行在旧 schema 的 SQLite 数据库上（schema_version 低于当前代码要求）。
- 已处理：
  - 开发库已重置并全量 seed 30,000+ 数据（含配套配置）。
  - 启动时若 `schema_version < CURRENT_SCHEMA_VERSION`，直接报错并提示迁移/重置方式（避免运行期大量 DATABASE_ERROR）。
  - 开发环境首次启动跳过复制“旧版本 seed DB”，避免把旧库复制到用户数据目录导致版本不匹配。

### B) `Timeout`（策略草案重算 / 发布 / get_refresh_status）

- 处理方向：
  - 高并发轮询的 `get_refresh_status` 保持轻量且不排队（避免被 blocking pool 饥饿）。
  - 大体量返回（如 `list_plan_items`）提高 IPC timeout，避免误报。
  - 继续优化：逐步将 UI 查询从“全量拉取”转为“按日期范围/分页拉取”，减少序列化与内存压力。

---

## 下一步 TODO（建议合并顺序）

- [x] P0：重算窗口天数 override（后端参数 + One-Click Optimize UI）
- [x] P0：策略配置画面展示预设参数（后端补齐 default_parameters + 前端只读展示）
- [ ] P1：大数据量查询/渲染优化（WorkBench planItems/materials 按范围/分页）
- [ ] P1：为关键链路补充性能指标（elapsed_ms、关键 SQL 计数、慢查询日志）
